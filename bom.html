<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Bill of Material (BOM)</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- CSS khusus tree BOM multi-level -->
  <style>
    .bom-tree {
      margin-top: 16px;
      display: flex;
      justify-content: center;
    }

    .bom-tree-branch {
      text-align: center;
      position: relative;
      padding-bottom: 18px;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
    }

    .bom-node {
      position: relative;
      display: inline-flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 8px 14px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.96);
      border: 1px solid rgba(148, 163, 184, 0.7);
      box-shadow: 0 14px 30px rgba(15, 23, 42, 0.9);
      font-size: 0.86rem;
      min-width: 120px;
    }

    .bom-node-root {
      background: radial-gradient(circle at 30% 0, rgba(56, 189, 248, 0.35), rgba(15, 23, 42, 0.96));
      border-color: rgba(56, 189, 248, 0.8);
      margin-bottom: 6px;
    }

    .bom-node-title {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .bom-node-qty {
      font-size: 0.78rem;
      color: #9ca3af;
    }

    .bom-tree-children {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 14px;
      position: relative;
      padding-top: 16px;
    }

    /* garis vertikal dari parent ke baris anak */
    .bom-tree-children::before {
      content: "";
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 2px;
      height: 14px;
      background: rgba(148, 163, 184, 0.7);
    }

    /* garis kecil di atas tiap node anak */
    .bom-tree-branch .bom-node::before {
      content: "";
      position: absolute;
      top: -12px;
      width: 1px;
      height: 12px;
      background: rgba(148, 163, 184, 0.7);
    }

    .bom-node-root::before {
      content: none;
    }

    @media (max-width: 640px) {
      .bom-node {
        min-width: 100px;
        padding-inline: 10px;
      }
    }
  </style>
</head>
<body>
<header>
  <h1>Bill of Material (BOM)</h1>
  <p>Perhitungan kebutuhan material untuk produksi (multi-level BOM).</p>
</header>

<main>
  <a href="index.html" class="back-link">&larr; Kembali ke Menu Utama</a>

  <section class="form-section">
    <h2>Input BOM</h2>

    <label>Nama Produk
      <input type="text" id="productName" placeholder="Contoh: Meja Kayu">
    </label>

    <label>Jumlah produk yang akan diproduksi
      <input type="number" id="productQty" min="1" value="10">
    </label>

    <p>
      Struktur BOM (satu baris per parent).<br>
      Format: <code>Parent: Anak1*qty, Anak2*qty, ...</code><br><br>
      Contoh Meja Kayu multi-level:<br>
      <code>Meja Kayu: Kaki Meja*4, Top Meja*1</code><br>
      <code>Kaki Meja: Baut*1, Kayu*1, Besi*1</code>
    </p>

    <textarea id="structureInput" rows="8"
      placeholder="Meja Kayu: Kaki Meja*4, Top Meja*1&#10;Kaki Meja: Baut*1, Kayu*1, Besi*1"></textarea>

    <button onclick="hitungBOM()"><span>Hitung Kebutuhan Material</span></button>

    <div id="result" class="result" style="display:none;"></div>

    <div class="chart-container">
      <canvas id="bomChart"></canvas>
    </div>
  </section>
</main>

<script>
let bomChart = null;

function hitungBOM() {
  const productName = document.getElementById('productName').value.trim() || 'Produk';
  const productQty = parseInt(document.getElementById('productQty').value, 10);
  const rawStruct = document.getElementById('structureInput').value.trim();

  if (!rawStruct || isNaN(productQty) || productQty <= 0) {
    alert('Masukkan struktur BOM dan jumlah produksi yang valid.');
    return;
  }

  // ===== PARSE STRUKTUR: Parent: Child*qty, Child2*qty ====
  const lines = rawStruct.split('\n').map(x => x.trim()).filter(x => x);
  const childrenMap = {};              // parent -> [{name, qtyPerParent}]
  const qtyPerParentMap = {};          // "parent||child" -> qty
  const allNodes = new Set();

  lines.forEach(line => {
    const parts = line.split(':');
    if (parts.length < 2) return;

    const parent = parts[0].trim();
    const rhs = parts[1].trim();
    if (!parent || !rhs) return;

    allNodes.add(parent);

    const childSpecs = rhs.split(',').map(x => x.trim()).filter(x => x);
    childSpecs.forEach(spec => {
      const cp = spec.split('*');
      const childName = cp[0].trim();
      const qty = cp[1] ? parseFloat(cp[1]) : 1;
      if (!childName || isNaN(qty) || qty <= 0) return;

      allNodes.add(childName);

      if (!childrenMap[parent]) childrenMap[parent] = [];
      childrenMap[parent].push({ name: childName, qtyPerParent: qty });
      qtyPerParentMap[parent + '||' + childName] = qty;
    });
  });

  if (!childrenMap[productName]) {
    alert('Produk utama belum memiliki baris parent di struktur BOM.');
    return;
  }

  // ===== TRAVERSAL & AKUMULASI TOTAL ====
  const totals = {};   // nama item -> total qty untuk semua produksi
  const steps = [];    // daftar string langkah

  function accumulate(name, qtyNeeded, path) {
    const currentPath = path.concat(name);
    totals[name] = (totals[name] || 0) + qtyNeeded;

    const children = childrenMap[name] || [];
    if (!children.length) return; // leaf / bahan mentah

    children.forEach(child => {
      const childTotal = qtyNeeded * child.qtyPerParent;
      const pathText = currentPath.join(' → ') + ' → ' + child.name;
      const stepText = 'Jalur ' + pathText + ': total = '
        + qtyNeeded + ' × ' + child.qtyPerParent
        + ' = ' + childTotal;
      steps.push(stepText);

      accumulate(child.name, childTotal, currentPath);
    });
  }

  accumulate(productName, productQty, []);

  // ===== TABEL REKAP ITEM =====
  const names = Object.keys(totals);
  // pastikan root di urutan paling atas
  names.sort((a, b) => {
    if (a === productName) return -1;
    if (b === productName) return 1;
    return a.localeCompare(b);
  });

  let tableHtml = ''
    + '<h2>Hasil Perhitungan BOM</h2>'
    + '<p>Produk utama: <strong>' + productName + '</strong><br>'
    + 'Jumlah produksi: <strong>' + productQty + '</strong> unit</p>'
    + '<h3>1. Rekap Kebutuhan Setiap Item</h3>'
    + '<table>'
    + '<tr>'
    +   '<th>Item</th>'
    +   '<th>Keterangan</th>'
    +   '<th>Kebutuhan per 1 ' + productName + '</th>'
    +   '<th>Kebutuhan total (' + productQty + ' unit)</th>'
    + '</tr>';

  names.forEach(name => {
    const totalForLot = totals[name];
    const perUnit = (totalForLot / productQty);
    const isRoot = name === productName;
    const keterangan = isRoot ? 'Produk jadi' : (childrenMap[name] ? 'Sub-assembly / komponen rakitan' : 'Bahan / komponen dasar');

    tableHtml += '<tr>'
      + '<td>' + name + '</td>'
      + '<td>' + keterangan + '</td>'
      + '<td>' + perUnit + '</td>'
      + '<td>' + totalForLot + '</td>'
      + '</tr>';
  });

  tableHtml += '</table>';

  // ===== LANGKAH PERHITUNGAN =====
  let langkahHtml = '<h3>2. Langkah Perhitungan</h3>';
  langkahHtml += '<p>Rumus umum:<br>'
    + '<em>Total anak = (kebutuhan parent) × (qty anak per 1 parent)</em></p>';
  langkahHtml += '<ol>';
  steps.forEach(s => {
    langkahHtml += '<li>' + s + '</li>';
  });
  langkahHtml += '</ol>';

  // ===== STRUKTUR TREE (REKURSIF) =====
  function renderNode(name, parent) {
    const children = childrenMap[name] || [];
    const isRoot = parent === null;
    const totalQty = totals[name] || 0;
    const perParent = parent ? (qtyPerParentMap[parent + '||' + name] || null) : null;

    let html = '<div class="bom-tree-branch">';
    html += '<div class="bom-node' + (isRoot ? ' bom-node-root' : '') + '">';
    html += '<div class="bom-node-title">' + name + '</div>';
    html += '<div class="bom-node-qty">';
    if (perParent) {
      html += perParent + 'x / parent · ';
    }
    html += totalQty + 'x total';
    html += '</div></div>'; // node

    if (children.length) {
      html += '<div class="bom-tree-children">';
      children.forEach(child => {
        html += renderNode(child.name, name);
      });
      html += '</div>';
    }

    html += '</div>'; // branch
    return html;
  }

  const treeHtml =
    '<h3>3. Struktur BOM (Tree)</h3>'
    + '<p>Visualisasi hubungan antara produk utama dengan sub-assembly dan komponen di semua level.</p>'
    + '<div class="bom-tree">'
    + renderNode(productName, null)
    + '</div>';

  const kesimpulan =
    '<h3>4. Kesimpulan</h3>'
    + '<p>Untuk memproduksi <strong>' + productQty + '</strong> unit '
    + '<strong>' + productName + '</strong>, dibutuhkan item-item sesuai '
    + 'rekap perhitungan dan struktur BOM di atas.</p>';

  const resDiv = document.getElementById('result');
  resDiv.innerHTML = tableHtml + langkahHtml + treeHtml + kesimpulan;
  resDiv.style.display = 'block';

  // ===== CHART (hanya komponen selain produk utama) =====
  const chartLabels = [];
  const chartTotals = [];
  names.forEach(name => {
    if (name === productName) return;
    chartLabels.push(name);
    chartTotals.push(totals[name]);
  });

  if (bomChart) bomChart.destroy();
  const ctx = document.getElementById('bomChart').getContext('2d');
  bomChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: chartLabels,
      datasets: [{
        label: 'Kebutuhan Total Komponen',
        data: chartTotals
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: true } }
    }
  });
}

// Animasi tombol & page load
document.addEventListener("DOMContentLoaded", () => {
  document.body.classList.add("page-loaded");

  const blocks = document.querySelectorAll(".card, .form-section");
  blocks.forEach((el, idx) => {
    el.style.animationDelay = (idx * 0.08) + "s";
    el.classList.add("slide-up");
  });

  document.querySelectorAll("button").forEach(btn => {
    btn.addEventListener("click", (e) => {
      const rect = btn.getBoundingClientRect();
      const circle = document.createElement("span");
      const diameter = Math.max(rect.width, rect.height);
      const radius = diameter / 2;

      circle.style.width = circle.style.height = diameter + "px";
      circle.style.position = "absolute";
      circle.style.left = (e.clientX - rect.left - radius) + "px";
      circle.style.top  = (e.clientY - rect.top  - radius) + "px";
      circle.style.borderRadius = "50%";
      circle.style.pointerEvents = "none";
      circle.style.background = "rgba(255,255,255,0.25)";
      circle.style.transform = "scale(0)";
      circle.style.opacity = "0.85";
      circle.style.transition = "transform 0.35s ease-out, opacity 0.4s ease-out";

      btn.style.position = "relative";
      btn.appendChild(circle);

      requestAnimationFrame(() => {
        circle.style.transform = "scale(1.6)";
        circle.style.opacity = "0";
      });

      setTimeout(() => circle.remove(), 420);
    });
  });
});
</script>
</body>
</html>
